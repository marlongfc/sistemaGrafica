/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package graficaatual.formularios.estoque;

import graficaatual.utilitarios.Data;
import graficaatual.utilitarios.VisualizaRelatorio;
import java.io.InputStream;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.swing.JFormattedTextField;
import javax.swing.JOptionPane;
import javax.swing.text.MaskFormatter;

/**
 *
 * @author Marlon
 */
public class FRelatorioEstoque extends javax.swing.JInternalFrame {

    // Tela
    private static int initControle;
    private static FRelatorioEstoque instance;

    private JFormattedTextField cpf;

    public FRelatorioEstoque() {

        initComponents();
        ((javax.swing.plaf.basic.BasicInternalFrameUI) this.getUI()).setNorthPane(null);

    }

    public static int isInicializado() {
        return initControle;
    }

    public synchronized static FRelatorioEstoque getInstance() {
        if (instance == null) {
            instance = new FRelatorioEstoque();
            initControle = 1;
        }
        return instance;
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel10 = new javax.swing.JPanel();
        try {
            cpf = new JFormattedTextField(
                new MaskFormatter("###.###.###-##"));
            ((JFormattedTextField) cpf).setFocusLostBehavior(0);

        } catch (Exception e) {
        }
        jLabel2 = new javax.swing.JLabel();
        jCRelatorio = new javax.swing.JComboBox<>();
        radioData = new javax.swing.JRadioButton();
        radioMaterial = new javax.swing.JRadioButton();
        labelData = new javax.swing.JLabel();
        data = new javax.swing.JTextField();
        imprimir = new javax.swing.JButton();
        sair = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        codMaterial = new javax.swing.JTextField();

        setBorder(null);
        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Cadastro de Cliente");
        setMinimumSize(new java.awt.Dimension(1100, 700));
        setNormalBounds(new java.awt.Rectangle(0, 0, 0, 0));
        setPreferredSize(new java.awt.Dimension(1100, 700));
        getContentPane().setLayout(null);

        jPanel10.setBackground(new java.awt.Color(255, 255, 255));
        jPanel10.setToolTipText("Cadastro de Pessoas");
        jPanel10.setMaximumSize(new java.awt.Dimension(999999, 999999));
        jPanel10.setMinimumSize(new java.awt.Dimension(1100, 700));
        jPanel10.setName(""); // NOI18N
        jPanel10.setPreferredSize(new java.awt.Dimension(1100, 700));
        jPanel10.setLayout(null);

        jLabel2.setFont(new java.awt.Font("Dialog", 1, 36)); // NOI18N
        jLabel2.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel2.setText("RELATÓRIOS DE ESTOQUE ");
        jPanel10.add(jLabel2);
        jLabel2.setBounds(50, 0, 970, 70);

        jCRelatorio.setFont(new java.awt.Font("Dialog", 1, 14)); // NOI18N
        jCRelatorio.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Selecione o Relatório Desejado", "Entradas de Material", "Saídas de Material", "Estoque" }));
        jCRelatorio.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                jCRelatorioItemStateChanged(evt);
            }
        });
        jPanel10.add(jCRelatorio);
        jCRelatorio.setBounds(100, 90, 430, 30);

        radioData.setBackground(new java.awt.Color(255, 255, 255));
        buttonGroup1.add(radioData);
        radioData.setFont(new java.awt.Font("Dialog", 1, 11)); // NOI18N
        radioData.setText("Por Data");
        radioData.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                radioDataStateChanged(evt);
            }
        });
        jPanel10.add(radioData);
        radioData.setBounds(100, 140, 210, 23);

        radioMaterial.setBackground(new java.awt.Color(255, 255, 255));
        buttonGroup1.add(radioMaterial);
        radioMaterial.setFont(new java.awt.Font("Dialog", 1, 11)); // NOI18N
        radioMaterial.setSelected(true);
        radioMaterial.setText("Por Material");
        radioMaterial.addChangeListener(new javax.swing.event.ChangeListener() {
            public void stateChanged(javax.swing.event.ChangeEvent evt) {
                radioMaterialStateChanged(evt);
            }
        });
        jPanel10.add(radioMaterial);
        radioMaterial.setBounds(320, 140, 210, 23);

        labelData.setFont(new java.awt.Font("Dialog", 0, 12)); // NOI18N
        labelData.setHorizontalAlignment(javax.swing.SwingConstants.LEFT);
        labelData.setText("Data");
        jPanel10.add(labelData);
        labelData.setBounds(100, 180, 100, 20);

        data.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                dataFocusLost(evt);
            }
        });
        jPanel10.add(data);
        data.setBounds(100, 200, 170, 20);

        imprimir.setFont(new java.awt.Font("Dialog", 0, 14)); // NOI18N
        imprimir.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imagens/imprimir2.png"))); // NOI18N
        imprimir.setText("Imprimir");
        imprimir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                imprimirActionPerformed(evt);
            }
        });
        jPanel10.add(imprimir);
        imprimir.setBounds(560, 320, 250, 40);

        sair.setFont(new java.awt.Font("Dialog", 0, 14)); // NOI18N
        sair.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imagens/SAIR2.png"))); // NOI18N
        sair.setText("Sair");
        sair.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                sairActionPerformed(evt);
            }
        });
        jPanel10.add(sair);
        sair.setBounds(310, 320, 250, 40);

        jLabel1.setFont(new java.awt.Font("Dialog", 0, 12)); // NOI18N
        jLabel1.setText("Código Material");
        jPanel10.add(jLabel1);
        jLabel1.setBounds(100, 230, 170, 16);

        codMaterial.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                codMaterialFocusLost(evt);
            }
        });
        jPanel10.add(codMaterial);
        codMaterial.setBounds(100, 250, 170, 20);

        getContentPane().add(jPanel10);
        jPanel10.setBounds(0, 0, 1100, 700);
        jPanel10.getAccessibleContext().setAccessibleName("Cadastro de Pessoas");

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void limparTela() {

        jCRelatorio.setSelectedIndex(0);
        radioData.setSelected(true);
        data.setText("");
        radioMaterial.setEnabled(true);
    }


    private void imprimirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_imprimirActionPerformed
        try {
            imprimir();
        } catch (Exception e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(this, "Erro: " + e.getMessage());
        }
    }//GEN-LAST:event_imprimirActionPerformed

    private void sairActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_sairActionPerformed
        limparTela();
        dispose();
    }//GEN-LAST:event_sairActionPerformed

    private void radioDataStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_radioDataStateChanged

    }//GEN-LAST:event_radioDataStateChanged

    private void dataFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_dataFocusLost

    }//GEN-LAST:event_dataFocusLost

    private void jCRelatorioItemStateChanged(java.awt.event.ItemEvent evt) {//GEN-FIRST:event_jCRelatorioItemStateChanged
    }//GEN-LAST:event_jCRelatorioItemStateChanged

    private void codMaterialFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_codMaterialFocusLost
        // TODO add your handling code here:
    }//GEN-LAST:event_codMaterialFocusLost

    private void radioMaterialStateChanged(javax.swing.event.ChangeEvent evt) {//GEN-FIRST:event_radioMaterialStateChanged
        if (radioMaterial.isSelected()) {
            data.setText("");
        }
    }//GEN-LAST:event_radioMaterialStateChanged


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JTextField codMaterial;
    private javax.swing.JTextField data;
    private javax.swing.JButton imprimir;
    private javax.swing.JComboBox<String> jCRelatorio;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JLabel labelData;
    private javax.swing.JRadioButton radioData;
    private javax.swing.JRadioButton radioMaterial;
    private javax.swing.JButton sair;
    // End of variables declaration//GEN-END:variables

    private void imprimir() throws Exception {
        String sql = "";
        String condData = "", condMaterial = "";
        HashMap parametros = null;

        if (radioData.isSelected()) {
            condData = " and e.dataCadastro<=" + Data.getDateSQL(data.getText());
            parametros = new HashMap();
            parametros.put("dataParam", Data.getDate(data.getText()));
        }

        if (radioMaterial.isSelected()) {
            condMaterial = " and e.codMaterial=" + codMaterial.getText();
        }

        switch (jCRelatorio.getSelectedIndex()) {

            case 1:
                sql = " select * from entradaEstoque e "
                        + " where e.cancelada=FALSE " + condData + condMaterial
                        + " order by e.dataCadastro asc";

                new VisualizaRelatorio().visRel("graficaatual/relatorios/arquivos/entradaMaterial.jasper", "RELATÓRIO DE ENTRADA DE MATERIAL", parametros, sql);
                break;
            case 2:
                sql = " select * from saidaEstoque e "
                        + " where e.cancelada=FALSE " + condData + condMaterial
                        + " order by e.dataCadastro asc";

                new VisualizaRelatorio().visRel("graficaatual/relatorios/arquivos/saidaMaterial.jasper", "RELATÓRIO DE SAÍDA DE MATERIAL", parametros, sql);
                break;

            case 3:

                sql = "with tmpSomaEntrada as (Select t.codMaterial, t.descMaterial, t.quantAlturaEntrada, t.quantLarguraEntrada, t.quantMetragemEntrada,"
                        + "                      t.quantLitroEntrada, t.quantPesoEntrada, t.quantUnidadeEntrada,"
                        + "                      Case t.unidadeMedida when 1 then (t.quantAlturaEntrada * t.quantLarguraEntrada) else "
                        + "                     + ((case when t.quantMetragemEntrada is null then 0 else t.quantMetragemEntrada end)  "
                        + "                     + (case when t.quantLitroEntrada is null then 0 else t.quantLitroEntrada end)  "
                        + "                      +(case when t.quantPesoEntrada is null then 0 else quantPesoEntrada end)"
                        + "                      + (case when t.quantUnidadeEntrada is null then 0 else quantUnidadeEntrada end)) end as quantidadeTotal"
                        + "                      "
                        + "                      from (select e.codMaterial as codMaterial, m.unidademedida as unidadeMedida, e.descMaterial as descMaterial, Sum(e.altura) as quantAlturaEntrada, Sum(e.largura) as quantLarguraEntrada, Sum(e.metragemLinear) as quantMetragemEntrada,"
                        + "                      Sum(e.litro) as quantLitroEntrada, Sum(e.peso) as quantPesoEntrada, Sum(e.unidade) as quantUnidadeEntrada "
                        + "                      "
                        + "                      from entradaEstoque e "
                        + "                      left join material m on m.codMaterial=e.codMaterial"
                        + "                      where e.cancelada=FALSE " + condData + condMaterial
                        + "                      group by e.codMaterial, descMaterial, unidadeMedida order by e.codMaterial) as t), "
                        + "                      "
                        + "                      tempSomaSaida as (Select t.codMaterial, t.descMaterial, t.quantAlturaSaida, t.quantLarguraSaida, t.quantMetragemSaida,"
                        + "                      t.quantLitroSaida, t.quantPesoSaida, t.quantUnidadeSaida,"
                        + "                      Case t.unidadeMedida when 1 then (t.quantAlturaSaida * t.quantLarguraSaida) else "
                        + "                    +  ((case when t.quantMetragemSaida is null then 0 else t.quantMetragemSaida end) + "
                        + "                    +  (case when t.quantLitroSaida is null then 0 else t.quantLitroSaida end)  "
                        + "                    +  (case when t.quantPesoSaida is null then 0 else quantPesoSaida end)"
                        + "                    +   (case when t.quantUnidadeSaida is null then 0 else quantUnidadeSaida end)) end as quantidadeTotal"
                        + "                      "
                        + "                      from (select e.codMaterial as codMaterial, m.unidademedida as unidadeMedida, e.descMaterial as descMaterial, Sum(e.altura) as quantAlturaSaida, Sum(e.largura) as quantLarguraSaida, Sum(e.metragemLinear) as quantMetragemSaida,"
                        + "                      Sum(e.litro) as quantLitroSaida, Sum(e.peso) as quantPesoSaida, Sum(e.unidade) as quantUnidadeSaida "
                        + "                      "
                        + "                      from saidaEstoque e "
                        + "                      left join material m on m.codMaterial=e.codMaterial"
                        + "                      where e.cancelada=FALSE " + condData + condMaterial
                        + "                      group by e.codMaterial, descMaterial, unidadeMedida order by e.codMaterial)  as t)"
                        + "                      "
                        + "                      Select tE.codMaterial, tE.descMaterial, "
                        + "                      ((Case when tE.quantAlturaEntrada is null then 0 else tE.quantAlturaEntrada end) - (Case when tS.quantAlturaSaida is null then 0 else tS.quantAlturaSaida end)) as quantAltura, "
                        + "                      ((Case when tE.quantLarguraEntrada is null then 0 else tE.quantLarguraEntrada end) - (Case when tS.quantLarguraSaida is null then 0 else tS.quantLarguraSaida end)) as quantLargura, "
                        + "                      ((Case when tE.quantMetragemEntrada is null then 0 else tE.quantMetragemEntrada end) - (Case when tS.quantMetragemSaida is null then 0 else tS.quantMetragemSaida end)) as quantMetragem, "
                        + "                      ((Case when tE.quantLitroEntrada is null then 0 else tE.quantLitroEntrada end) - (Case when tS.quantLitroSaida is null then 0 else tS.quantLitroSaida end)) as quantLitro, "
                        + "                      ((Case when tE.quantPesoEntrada is null then 0 else tE.quantPesoEntrada end) - (Case when tS.quantPesoSaida is null then 0 else tS.quantPesoSaida end)) as quantPeso, "
                        + "                      ((Case when tE.quantUnidadeEntrada is null then 0 else tE.quantUnidadeEntrada end) - (Case when tS.quantUnidadeSaida is null then 0 else tS.quantUnidadeSaida end)) as quantUnidade, "
                        + "                      ((Case when tE.quantidadeTotal is null then 0 else tE.quantidadeTotal end) - (Case when tS.quantidadeTotal is null then 0 else tS.quantidadeTotal end)) as quantTotal, "
                        + "                       m.estoqueMinimo as estoqueMin, "
                        + "                      Case when ((Case when tE.quantidadeTotal is null then 0 else tE.quantidadeTotal end) - (Case when tS.quantidadeTotal is null then 0 else tS.quantidadeTotal end))<=m.estoqueMinimo then true else false end as estoqueAbaixoMinimo"
                        + "                      "
                        + "                      from tmpSomaEntrada as tE"
                        + "                      left Join tempSomaSaida as tS on tE.codMaterial = tS.codMaterial "
                        + "                      left Join material as m on m.codMaterial = tE.codMaterial"
                        + "                      "
                        + "                      order by tE.descMaterial";

                new VisualizaRelatorio().visRel("graficaatual/relatorios/arquivos/estoque.jasper", "Listagem de Estoque Por Data", parametros, sql);
                break;

            default:
                JOptionPane.showMessageDialog(this, "Erro na seleção");
                break;
        }
    }

}
